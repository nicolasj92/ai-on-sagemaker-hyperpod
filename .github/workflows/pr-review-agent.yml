name: Automated PR Review with Bedrock

on:
  schedule:
    - cron: '0 9 * * *'  # Daily at 9 AM UTC
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:  # Manual trigger

permissions:
  contents: read
  pull-requests: read
  id-token: write  # Required for OIDC

jobs:
  review-prs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install boto3

      - name: Configure AWS credentials (if needed)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::159553542841:role/awslabs-AOSH-GitHubActionsRole
          aws-region: us-east-1

      - name: Fetch all open PRs
        id: fetch-prs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr list --json number,title,author,url,headRefName --limit 100 > prs.json
          echo "pr_count=$(jq length prs.json)" >> $GITHUB_OUTPUT

      - name: Review PRs with Bedrock
        if: steps.fetch-prs.outputs.pr_count > 0
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: python review_prs.py

      #- name: Send results to Slack
      #  if: steps.fetch-prs.outputs.pr_count > 0
      #  uses: slackapi/slack-github-action@v1.26.0
      #  with:
      #    channel-id: ${{ secrets.SLACK_CHANNEL_ID }}
      #    slack-message: "PR Review Report - $(date +%Y-%m-%d)"
      #  env:
      #    SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}

      #- name: Upload review file to Slack
      #  if: steps.fetch-prs.outputs.pr_count > 0
      #  run: |
      #    curl -F file=@review_results.md \
      #         -F "channels=${{ secrets.SLACK_CHANNEL_ID }}" \
      #         -F "title=PR Review - $(date +%Y-%m-%d)" \
      #         -F "initial_comment=Automated PR review results" \
      #         -H "Authorization: Bearer ${{ secrets.SLACK_BOT_TOKEN }}" \
      #         https://slack.com/api/files.upload

      - name: Upload review artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pr-review-results
          path: review_results.md
          retention-days: 30
